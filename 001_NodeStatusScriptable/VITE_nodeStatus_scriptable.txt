// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: deep-gray; icon-glyph: magic;

const urlGetAlivePeers = (viteAddress) => `https://stats.vite.net/api/getAlivePeers?address=vite_adress`
// ${encodeURIComponent(viteAddress)}`

const nodeDetail = [['x.x.x.ip1', 'nodeName1'],['...', '....']]

let widget = await createWidget()
if (!config.runsInWidget) {
 await widget.presentSmall()
}

Script.setWidget(widget)
Script.complete()

async function createWidget(items) {
 let viteAddress

 if(args.widgetParameter) {
   console.log('get fixed lat/lon')
   const fixedAdr = args.widgetParameter.split(",").map(parseFloat)
   viteAddress = {
     addr: fixedAdr[0]
   }
 } else {
   viteAddress = 'viteAdress...'
 }
 console.log(urlGetAlivePeers(viteAddress))

//   const data = await new Request(urlGetAlivePeers(viteAddress)).loadJSON()
//   let req = new Request(urlGetAlivePeers(viteAddress))
//   req.method = "GET"
//   const data = await req.loadJSON()
//   console.log(data)

//   const size = data.size

 const list = new ListWidget()
 const header = list.addText("Vite Nodes ðŸŒ–")
 header.font = Font.mediumSystemFont(13)

 list.addSpacer(5)

 for (i = 0; i < nodeDetail.length; i++) {
   const ip = nodeDetail[i][0]
   const name = nodeDetail[i][1]
//     console.log(nodeDetail[i])

//     console.log("http://" + ip + ":48132")
   let req2 = new Request("http://" + ip + ":48132")
   req2.allowInsecureRequest = true
   req2.method = "POST"
   req2.headers = {
     "Cache-Control": "no-cache",
     "Content-Type": "application/json"
   }
   req2.body = JSON.stringify({
     "jsonrpc": "2.0",
     "id": 2,
     "method": "ledger_getSnapshotChainHeight",
     "params": null
   })
   try {
     const data2 = await req2.loadJSON()

     if (!data2) {
       let lT = list.addText(name + ": offline")
       lT.font = Font.regularMonospacedSystemFont(9)
     } else {
       let lT = list.addText(name + ": " + Number(data2.result).toLocaleString())
       lT.font = Font.regularMonospacedSystemFont(9)
     }
   } catch (error) {
//   console.error(error)
     let lT = list.addText(name + ": offline")
     lT.font = Font.regularMonospacedSystemFont(9)
   }
 }

//   if(!data || !data.list|| !data.list.length) {
//     const errorList = new ListWidget()
//     errorList.addText("Keine Ergebnisse von GetAlivePeers")
//     return errorList
//   }

//   for (node in data.list) {
//   for (i = 0; i < data.list.length; i++) {
//     list.addText(data.list[i].nodeName + ": " + data.list[i].isAlive)
//   }

 return list
}